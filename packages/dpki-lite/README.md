# hc-dpki

holochain key management libraries and utilities

## 1 - Holochain Application-Level Key Management & Cryptography

Holochain crypto is based on [NACL](https://nacl.cr.yp.to/) / [libsodium](https://libsodium.org/).

### 1.1 - Keypairs

Keypair is a bit of a misnomer. It is more of a pair of keypairs. A holochain "keypair" is made up of both a signing keypair and a key exchange keypair for use in encryption. Both pairs are derived from a common seed.

- signature keypair - `crypto_sign_seed_keypair` `Ed25519`
- encryption keypair - `crypto_kx_seed_keypair` `BLAKE2B-512`

### 1.2 - Identity

The identifier for an agent is derived from the public sides of the signing and encryption keypairs. A two byte checksum is appended, and a base64url transform is applied.

- Identifier - `[32 byte signing pubkey][32 byte encryption pubkey][2 bytes checksum]`

The checksum bytes are generated by taking the sha256 sum of both the signing and encryption pubkeys, then applying an xor to each successive 2 bytes of that resulting sum.

Checksum psuedo code:

```
hash = sha256( concat( signPubkey, encPubkey ) )
sum = (int16) hash[0]
loop i from 2 to 32 step 2 {
    sum = sum ^ (int16) hash[i]
}
```

The [Base64url](https://tools.ietf.org/html/rfc4648#section-5) encoding variant (`-` and `_` instead of `+` and `/`) is used to make the identifier more compatible with urls and filenames.

Example:

- Signature Pubkey: `8c59ff8b384e13cb6e65ea29345e605e075b3bdd93f21fcaf2c132a460d5b0e0`
- Encryption Pubkey: `794ebb53296ce3362b780d9206f0e263b94e5f0e73c4a28fa62055196a7dad38`
- Checksum Bytes: `d592`
- Resulting ID: `jFn_izhOE8tuZeopNF5gXgdbO92T8h_K8sEypGDVsOB5TrtTKWzjNit4DZIG8OJjuU5fDnPEoo-mIFUZan2tONWS`

## 2 - Holochain Hierarchical Seed Determinism

Holochain makes use of 2 NACL methods for deriving keys

- kdf - `crypto_kdf_derive_from_key` `BLAKE2B-256`
- pwhash - `crypto_pwhash` `argon2id13` ("sensitive" ops and mem limits)

All seeds are 32 bytes.

### 2.1 - Root Seed

The holochain HD root seed is pure entropy.

### 2.2 - Device Seed

The device seed is derived through the kdf method for a given index with the ascii byte context `HCDEVICE`.

### 2.3 - Device PIN Seed

The device pin seed is derived through the pwhash method. This is an attempt to allow alternate input methods for a derivation to work around potential keylogging malware. For example, on a mobile device, a 3x3 grid of numbers 1-9 could be randomly assigned / randomly re-assigned after each input by the user.

### 2.4 - Application Keypair Seed

The application keypair seed is derived through the kdf method for a given index with the ascii byte context `HCAPPLIC`.
